<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS.js Test</title>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #b300ff;
            text-align: center;
        }
        .video-container {
            width: 100%;
            background-color: #111;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        video {
            width: 100%;
            display: block;
        }
        .controls {
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #b300ff;
        }
        input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin-bottom: 15px;
            background-color: #222;
            border: 1px solid #333;
            color: #fff;
            border-radius: 4px;
        }
        button {
            background-color: #b300ff;
            color: #fff;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #9700d6;
        }
        .status {
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
        }
        .status.error {
            background-color: rgba(255, 0, 0, 0.2);
            border-left: 4px solid #ff5555;
        }
        .status.success {
            background-color: rgba(0, 255, 0, 0.2);
            border-left: 4px solid #55ff55;
        }
        .example-links {
            margin-top: 20px;
            padding: 15px;
            background-color: #222;
            border-radius: 6px;
        }
        .example-link {
            color: #55aaff;
            cursor: pointer;
            text-decoration: none;
            display: block;
            margin-bottom: 10px;
        }
        .example-link:hover {
            text-decoration: underline;
        }
        .version-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HLS.js Video Player Test</h1>

        <div class="video-container">
            <video id="videoPlayer" controls></video>
        </div>

        <div class="controls">
            <label for="videoUrl">HLS/m3u8 URL:</label>
            <input type="text" id="videoUrl" placeholder="Enter HLS/m3u8 stream URL">

            <div>
                <button id="playBtn">Play Video</button>
                <button id="stopBtn">Stop Video</button>
            </div>

            <div id="status" class="status"></div>
        </div>

        <div class="example-links">
            <h3>Example HLS Streams:</h3>
            <a href="#" class="example-link" data-url="https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8">Test Stream 1 (Mux.dev)</a>
            <a href="#" class="example-link" data-url="https://vvf5.d21-anime77.com/7d2437233f05a9cf027ad847aa1d43ee9a776be088a06749d32370ca/episodedata/m3u8/t/tokyo-ghoul-episode-1-1648231517.m3u8">Tokyo Ghoul Episode 1</a>
            <a href="#" class="example-link" data-url="https://lol.aheg-anime.com/90d72e1f7031cc5467854fec01755477fef3951ebb3a8fad02f7a36b/episodedata/m3u8/t/shingeki-no-kyojin-season-1-episode-1-1648239345.m3u8">Attack on Titan Episode 1</a>
        </div>

        <div class="version-info">
            <p>HLS.js version: <span id="hlsVersion">Loading...</span></p>
            <p>Browser: <span id="browserInfo"></span></p>
        </div>
    </div>

    <!-- Load HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12"></script>

    <script>
        // Get DOM elements
        const videoPlayer = document.getElementById('videoPlayer');
        const videoUrlInput = document.getElementById('videoUrl');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusElement = document.getElementById('status');
        const exampleLinks = document.querySelectorAll('.example-link');
        const hlsVersionElement = document.getElementById('hlsVersion');
        const browserInfoElement = document.getElementById('browserInfo');

        // HLS instance
        let hls = null;

        // Display HLS.js version and browser info
        window.addEventListener('load', function() {
            if (window.Hls) {
                hlsVersionElement.textContent = Hls.version || 'Unknown';
                showStatus('HLS.js loaded successfully', 'success');
            } else {
                hlsVersionElement.textContent = 'Not available';
                showStatus('HLS.js failed to load', 'error');
            }

            // Show browser info
            const browserInfo = `${navigator.userAgent}`;
            browserInfoElement.textContent = browserInfo;
        });

        // Set up example links
        exampleLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const url = this.getAttribute('data-url');
                videoUrlInput.value = url;
                showStatus(`Stream URL set: ${url}`, 'success');
            });
        });

        // Play button click handler
        playBtn.addEventListener('click', function() {
            const videoUrl = videoUrlInput.value.trim();

            if (!videoUrl) {
                showStatus('Please enter a valid HLS/m3u8 URL', 'error');
                return;
            }

            playHlsStream(videoUrl);
        });

        // Stop button click handler
        stopBtn.addEventListener('click', function() {
            destroyHlsInstance();
            videoPlayer.src = '';
            videoPlayer.load();
            showStatus('Video playback stopped', 'success');
        });

        // Function to play HLS stream
        function playHlsStream(url) {
            // First destroy any existing HLS instance
            destroyHlsInstance();

            showStatus(`Attempting to play: ${url}`, '');

            // Check if HLS.js is supported
            if (Hls.isSupported()) {
                try {
                    hls = new Hls({
                        debug: false,
                        enableWorker: true,
                        lowLatencyMode: true,
                        xhrSetup: function(xhr) {
                            xhr.withCredentials = false; // Disable passing cookies for cross-origin requests
                        }
                    });

                    // Error handler
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS.js error:', event, data);

                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    showStatus(`Network error: ${data.details}. This may be due to CORS restrictions.`, 'error');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    showStatus('Media error, attempting to recover', 'error');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    showStatus(`Fatal error: ${data.details}`, 'error');
                                    destroyHlsInstance();
                                    break;
                            }
                        }
                    });

                    // Success handler
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        showStatus('HLS manifest parsed, starting playback', 'success');
                        videoPlayer.play().catch(err => {
                            console.error('Error starting playback:', err);
                            showStatus(`Playback error: ${err.message}`, 'error');
                        });
                    });

                    // Load source and attach media
                    hls.loadSource(url);
                    hls.attachMedia(videoPlayer);
                } catch (error) {
                    console.error('Error setting up HLS.js:', error);
                    showStatus(`HLS.js error: ${error.message}`, 'error');
                }
            }
            // For browsers that support HLS natively (Safari)
            else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                try {
                    showStatus('Using native HLS support', 'success');
                    videoPlayer.src = url;

                    videoPlayer.addEventListener('loadedmetadata', function() {
                        videoPlayer.play().catch(err => {
                            console.error('Error starting playback:', err);
                            showStatus(`Playback error: ${err.message}`, 'error');
                        });
                    });

                    videoPlayer.addEventListener('error', function() {
                        showStatus(`Video error: ${videoPlayer.error?.message || 'Unknown error'}`, 'error');
                    });
                } catch (error) {
                    showStatus(`Error with native HLS: ${error.message}`, 'error');
                }
            } else {
                showStatus('Your browser does not support HLS playback', 'error');
            }
        }

        // Function to destroy HLS instance
        function destroyHlsInstance() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
        }

        // Function to show status messages
        function showStatus(message, type) {
            statusElement.textContent = message;
            statusElement.className = 'status';
            if (type) {
                statusElement.classList.add(type);
            }
        }
    </script>
</body>
</html>
