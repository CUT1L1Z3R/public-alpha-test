<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Anime API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #b300ff;
        }
        .test-form {
            margin: 20px 0;
            padding: 20px;
            background-color: #111;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #b300ff;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #333;
            border-radius: 3px;
            background-color: #222;
            color: #fff;
        }
        button {
            background-color: #b300ff;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #9900d6;
        }
        #videoContainer {
            margin-top: 20px;
            width: 100%;
            background-color: #111;
            border-radius: 5px;
            overflow: hidden;
        }
        video {
            width: 100%;
            max-height: 500px;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background-color: #111;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: rgba(0, 128, 0, 0.2);
            color: #5cff5c;
        }
        .error {
            background-color: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
        }

        /* Additional styles for API info section */
        .api-info {
            margin: 20px 0;
            padding: 15px;
            background-color: rgba(179, 0, 255, 0.1);
            border-radius: 5px;
            border-left: 4px solid #b300ff;
        }

        .api-info h3 {
            color: #b300ff;
            margin-top: 0;
        }

        .api-info code {
            display: block;
            padding: 10px;
            background-color: #222;
            border-radius: 5px;
            overflow-x: auto;
            color: #50fa7b;
            margin: 10px 0;
        }

        .api-info strong {
            color: #ff79c6;
        }

        .example-link {
            color: #8be9fd;
            text-decoration: none;
            cursor: pointer;
        }

        .example-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Anime API Test</h1>
        <p>Test the anime video playback using the Anime Rouge API</p>

        <div class="test-form">
            <div class="form-group">
                <label for="episodeId">Episode ID (format: anime-name-12345?ep=67890)</label>
                <input type="text" id="episodeId" placeholder="e.g. solo-leveling-18718?ep=120094" value="solo-leveling-18718?ep=120094" />
            </div>
            <div class="form-group">
                <label for="server">Server</label>
                <select id="server">
                    <option value="vidstreaming">vidstreaming</option>
                    <option value="streamsb">streamsb</option>
                    <option value="vidcdn">vidcdn</option>
                </select>
            </div>
            <div class="form-group">
                <label for="category">Category</label>
                <select id="category">
                    <option value="sub">sub</option>
                    <option value="dub">dub</option>
                </select>
            </div>

            <div class="api-info">
                <h3>Important Note:</h3>
                <p>The correct API endpoint format is:</p>
                <code>https://api-anime-rouge.vercel.app/aniwatch/episode-srcs?id={episodeId}&server={server}&category={category}</code>
                <p>Make sure to use <strong>aniwatch</strong> in the path, not <strong>anime</strong>.</p>
                <p>Example URLs to try:</p>
                <ul>
                    <li><a href="#" class="example-link" data-id="tokyo-ghoul-114?ep=1778">Tokyo Ghoul - Episode 1</a></li>
                    <li><a href="#" class="example-link" data-id="jujutsu-kaisen-2nd-season-18413?ep=110325">Jujutsu Kaisen S2 - Episode 1</a></li>
                    <li><a href="#" class="example-link" data-id="spy-x-family-17631?ep=99548">Spy x Family - Episode 1</a></li>
                </ul>
            </div>

            <button id="testApi">Test API Connection</button>
            <button id="playVideo">Play Video</button>
            <div id="status" class="status"></div>
        </div>

        <div id="videoContainer" style="display: none;">
            <video id="videoPlayer" controls></video>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Load HLS.js for m3u8 support
        const hlsScript = document.createElement('script');
        hlsScript.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
        document.head.appendChild(hlsScript);

        // Helper function to format the episodeId correctly if needed
        function formatEpisodeId(id) {
            if (!id) return null;

            // If already in correct format (contains ?ep=), return as is
            if (id.includes('?ep=')) {
                return id;
            }

            // If it's just a number, throw error - we need anime ID
            if (!isNaN(id) && id.trim() !== '') {
                showStatus('Episode ID must include anime ID, not just episode number', 'error');
                return null;
            }

            // If no episode specification, default to episode 1
            return `${id}?ep=1`;
        }

        // Function to build the API URL with the correct format
        function buildApiUrl(episodeId, server, category) {
            const formattedId = formatEpisodeId(episodeId);
            if (!formattedId) return null;

            return `https://api-anime-rouge.vercel.app/aniwatch/episode-srcs?id=${formattedId}&server=${server}&category=${category}`;
        }

        // When test button is clicked
        document.getElementById('testApi').addEventListener('click', async () => {
            const episodeId = document.getElementById('episodeId').value;
            const server = document.getElementById('server').value;
            const category = document.getElementById('category').value;

            if (!episodeId) {
                showStatus('Please enter an episode ID', 'error');
                return;
            }

            showStatus('Testing API connection...', '');

            try {
                const apiUrl = buildApiUrl(episodeId, server, category);
                if (!apiUrl) {
                    throw new Error('Invalid episode ID format');
                }

                console.log(`Fetching from: ${apiUrl}`);
                showStatus(`Testing connection to: ${apiUrl}`, '');

                const startTime = Date.now();
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const endTime = Date.now();
                const responseTime = endTime - startTime;

                if (!response.ok) {
                    throw new Error(`API response error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                // Display the raw response
                document.getElementById('results').textContent = JSON.stringify(data, null, 2);

                console.log('API Response:', data);

                if (data && (data.sources?.length > 0 || data.m3u8)) {
                    showStatus(`API connection successful! Response time: ${responseTime}ms. Found ${data.sources?.length || 1} sources.`, 'success');

                    // Show source details
                    if (data.sources) {
                        data.sources.forEach((source, index) => {
                            console.log(`Source ${index+1}:`, source);
                        });
                    }
                } else if (data && data.error) {
                    // API returned an error message
                    showStatus(`API error: ${data.error}`, 'error');
                } else {
                    showStatus('API connection successful, but no valid sources found.', 'error');
                }
            } catch (error) {
                console.error('API Error:', error);
                document.getElementById('results').textContent = error.toString();

                // More detailed error message
                let errorMsg = `Error: ${error.message}`;

                // Add more context for specific errors
                if (error.message.includes('Failed to fetch')) {
                    errorMsg += ' - This could be due to CORS issues, network problems, or the API being unavailable.';
                } else if (error.message.includes('404')) {
                    errorMsg += ' - The API endpoint could not be found. Make sure you\'re using the correct URL format.';
                } else if (error.message.includes('500')) {
                    errorMsg += ' - The API server encountered an internal error. Please try again later.';
                }

                showStatus(errorMsg, 'error');
            }
        });

        // Add click handlers for example links
        document.querySelectorAll('.example-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const episodeId = link.getAttribute('data-id');
                document.getElementById('episodeId').value = episodeId;
                showStatus(`Set episode ID to: ${episodeId}`, 'success');
            });
        });

        // When play button is clicked
        document.getElementById('playVideo').addEventListener('click', async () => {
            const episodeId = document.getElementById('episodeId').value;
            const server = document.getElementById('server').value;
            const category = document.getElementById('category').value;

            if (!episodeId) {
                showStatus('Please enter an episode ID', 'error');
                return;
            }

            showStatus('Loading video...', '');

            try {
                const apiUrl = buildApiUrl(episodeId, server, category);
                if (!apiUrl) {
                    throw new Error('Invalid episode ID format');
                }

                console.log(`Fetching video sources from: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API response error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                document.getElementById('results').textContent = JSON.stringify(data, null, 2);

                console.log('Video API Response:', data);

                let videoUrl = '';
                let isM3U8 = false;

                // Get first available source
                if (data.sources && data.sources.length > 0) {
                    // Display all available sources
                    console.log(`Found ${data.sources.length} sources:`, data.sources);

                    // Sort sources by quality (highest first)
                    const sortedSources = [...data.sources].sort((a, b) => {
                        // Extract quality numbers
                        const getQualityNumber = (src) => {
                            if (!src.quality || typeof src.quality !== 'string') return 0;
                            const match = src.quality.match(/(\d+)p/);
                            return match ? parseInt(match[1]) : 0;
                        };

                        return getQualityNumber(b) - getQualityNumber(a);
                    });

                    console.log('Sources sorted by quality:', sortedSources);

                    // Select the best source
                    const bestSource = sortedSources[0];

                    videoUrl = bestSource.url;
                    // Check if it's an HLS source
                    isM3U8 = bestSource.isM3U8 || videoUrl.includes('.m3u8');
                    console.log(`Selected best quality source: ${videoUrl}`);
                    console.log(`Source type: ${isM3U8 ? 'HLS/m3u8' : 'Direct MP4'}`);
                    console.log(`Quality: ${bestSource.quality || 'unknown'}`);

                    // Show all available sources for debugging
                    data.sources.forEach((source, index) => {
                        console.log(`Source ${index+1} - URL: ${source.url.substring(0, 30)}... | Type: ${source.isM3U8 || source.url.includes('.m3u8') ? 'HLS' : 'MP4'} | Quality: ${source.quality || 'unknown'}`);
                    });
                } else if (data.m3u8) {
                    videoUrl = data.m3u8;
                    isM3U8 = true;
                    console.log(`Using m3u8 URL: ${videoUrl}`);
                }

                if (videoUrl) {
                    document.getElementById('videoContainer').style.display = 'block';
                    playVideo(videoUrl, isM3U8);
                    showStatus('Video loaded successfully!', 'success');
                } else {
                    showStatus('No video URL found in the API response.', 'error');
                }
            } catch (error) {
                console.error('Video Loading Error:', error);
                document.getElementById('results').textContent = error.toString();
                showStatus(`Error: ${error.message}`, 'error');
            }
        });

        // Function to play video
        function playVideo(videoUrl, isHLS) {
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.innerHTML = ''; // Clear any existing source elements

            // Log the video URL for debugging
            console.log(`Attempting to play: ${videoUrl} (HLS: ${isHLS})`);

            // If it's an HLS stream and HLS.js is supported
            if (isHLS && window.Hls && Hls.isSupported()) {
                try {
                    console.log('Using HLS.js to play m3u8');
                    const hls = new Hls({
                        debug: true,
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });

                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS Error:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    showStatus(`Network error while loading video: ${data.details}`, 'error');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    showStatus('Media error, attempting to recover', 'error');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    showStatus(`Fatal error: ${data.details}`, 'error');
                                    break;
                            }
                        }
                    });

                    hls.loadSource(videoUrl);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        videoPlayer.play().catch(e => {
                            console.error('Play error:', e);
                            showStatus('Failed to start playback. Try clicking play manually.', 'error');
                        });
                    });
                } catch (e) {
                    console.error('HLS.js error:', e);
                    showStatus(`HLS.js error: ${e.message}`, 'error');

                    // Fall back to native HLS if available
                    if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                        videoPlayer.src = videoUrl;
                        videoPlayer.addEventListener('loadedmetadata', () => {
                            videoPlayer.play().catch(e => console.error('Play error:', e));
                        });
                    }
                }
            }
            // For browsers that natively support HLS (like Safari)
            else if (isHLS && videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                console.log('Using native HLS support');
                videoPlayer.src = videoUrl;
                videoPlayer.addEventListener('loadedmetadata', () => {
                    videoPlayer.play().catch(e => {
                        console.error('Play error:', e);
                        showStatus('Failed to start playback. Try clicking play manually.', 'error');
                    });
                });
            }
            // For direct video URLs
            else {
                console.log('Using direct video URL with source element');
                const sourceElement = document.createElement('source');
                sourceElement.src = videoUrl;
                sourceElement.type = 'video/mp4';
                videoPlayer.appendChild(sourceElement);
                videoPlayer.load();
                videoPlayer.play().catch(e => {
                    console.error('Play error:', e);
                    showStatus('Failed to start playback. Try clicking play manually.', 'error');
                });
            }
        }

        // Function to show status messages
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status';
            if (type) {
                statusEl.classList.add(type);
            }
        }
    </script>
</body>
</html>
